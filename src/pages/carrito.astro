---
import BaseLayout from "../layouts/BaseLayout.astro";
import CartClient from "../components/cart/CartClient.jsx";
import { enviarWhatsApp } from "../utils/whatsapp.js";
---

<BaseLayout title="Carrito - ReposterÃ­a D'Rossy">
  <div class="min-h-screen bg-gradient-to-b from-yellow-50 to-orange-100 p-6">

    <!-- TÃTULO -->
    <h1 class="text-5xl font-extrabold text-center mb-8 text-orange-600 drop-shadow-lg tracking-wide">
      ðŸ›’ Tu Carrito
    </h1>

    <div class="max-w-5xl mx-auto grid md:grid-cols-3 gap-8">

      <!-- LISTA DE PRODUCTOS -->
      <div class="md:col-span-2">
        <ul id="cart-list" class="space-y-4"></ul>
      </div>

      <!-- RESUMEN -->
      <aside class="bg-white/90 backdrop-blur-lg rounded-3xl shadow-xl p-7 space-y-5 border border-orange-200">
        <h2 class="text-2xl font-bold text-orange-600">Resumen del pedido</h2>

        <div class="border-t pt-3">
          <p id="empty-msg" class="text-gray-500 text-center hidden">Tu carrito estÃ¡ vacÃ­o.</p>
        </div>

        <div class="flex justify-between font-bold text-xl text-gray-700">
          <span>Total:</span>
          <span id="total" class="text-orange-600">$0.00</span>
        </div>

        <button
          id="checkout-btn"
          class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white py-3 rounded-xl font-semibold text-lg shadow-md hover:shadow-lg hover:scale-[1.02] transition-all">
          ðŸ§¾ Realizar Pedido
        </button>
      </aside>

    </div>
  </div>

  <!-- SCRIPT -->
  <script is:inline>
    const cartList = document.getElementById('cart-list');
    const totalSpan = document.getElementById('total');
    const emptyMsg = document.getElementById('empty-msg');
    const checkoutBtn = document.getElementById('checkout-btn');

    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

    function showToast(message, color = 'green') {
      const toast = document.createElement("div");
      toast.className = `toast fixed bottom-6 right-6 px-5 py-3 rounded-lg text-white font-semibold shadow-lg bg-${color}-500`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    function renderCart() {
      cartList.innerHTML = '';

      if (cart.length === 0) {
        emptyMsg.classList.remove("hidden");
        totalSpan.textContent = "$0.00";
        return;
      } else {
        emptyMsg.classList.add("hidden");
      }

      let total = 0;

      cart.forEach((item, index) => {
        const li = document.createElement('li');
        li.className =
          "flex items-center justify-between bg-white p-4 rounded-2xl shadow-md hover:shadow-lg transition-all border border-orange-200 animate-fade-in";

        li.innerHTML = `
          <div class="flex items-center gap-4">
            <img 
              src="${item.img || '/assets/placeholder.png'}"
              alt="${item.name}"
              class="w-16 h-16 rounded-xl object-cover border border-orange-200 shadow-sm bg-white"
              onerror="this.src='/assets/placeholder.png';"
            />
            <div class="leading-tight">
              <p class="font-bold text-gray-800 text-lg">${item.name}</p>
              <p class="text-sm text-gray-500">$${item.price} x ${item.qty}</p>
            </div>
          </div>

          <button data-index="${index}"
            class="text-red-500 hover:text-red-700 text-xl font-bold px-3 transition">
            âœ•
          </button>
        `;

        cartList.appendChild(li);

        li.querySelector('button').onclick = (e) => {
          const i = Number(e.target.dataset.index);
          const removed = cart.splice(i, 1)[0];
          localStorage.setItem('cart', JSON.stringify(cart));
          renderCart();
          showToast(`${removed.name} eliminado`, "red");
        };

        total += item.price * item.qty;
      });

      totalSpan.textContent = `$${total.toFixed(2)}`;
    }

    renderCart();

    checkoutBtn.onclick = () => {
      if (cart.length === 0) return showToast("Tu carrito estÃ¡ vacÃ­o", "red");

      const total = cart.reduce((sum, p) => sum + p.price * p.qty, 0);

      showToast(`Pedido enviado ðŸŽ‰ Total: $${total.toFixed(2)}`, "green");

      // --- ENVIAR WHATSAPP ---
      enviarWhatsApp({
        total,
        productos: cart.map(item => ({
          nombre: item.name,
          cantidad: item.qty,
          precio: item.price
        })),
        user_email: "75866937@continental.edu.pe"
      });

      cart = [];
      localStorage.removeItem('cart');
      renderCart();
    };
  </script>

  <!-- ESTILOS -->
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .animate-fade-in {
      animation: fadeIn 0.35s ease-out forwards;
    }
  </style>
</BaseLayout>
