---
import BaseLayout from "../layouts/BaseLayout.astro";
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);
const telefonoDuenha = import.meta.env.PUBLIC_TELEFONO_DUEÃ‘A;
---

<BaseLayout title="Carrito - ReposterÃ­a D'Rossy">
  <div class="min-h-screen bg-gradient-to-b from-yellow-50 to-orange-100 p-6">

    <!-- TÃTULO -->
    <h1 class="text-5xl font-extrabold text-center mb-8 text-orange-600 drop-shadow-lg tracking-wide">
      ðŸ›’ Tu Carrito
    </h1>

    <div class="max-w-5xl mx-auto grid md:grid-cols-3 gap-8">

      <!-- LISTA DE PRODUCTOS -->
      <div class="md:col-span-2">
        <ul id="cart-list" class="space-y-4"></ul>
        <!-- Contenedor de productos para agregar al carrito -->
        <div id="products-container" class="grid grid-cols-3 gap-6 mt-8"></div>
      </div>

      <!-- RESUMEN -->
      <aside class="bg-white/90 backdrop-blur-lg rounded-3xl shadow-xl p-7 space-y-5 border border-orange-200">
        <h2 class="text-2xl font-bold text-orange-600">Resumen del pedido</h2>

        <div class="border-t pt-3">
          <p id="empty-msg" class="text-gray-500 text-center hidden">Tu carrito estÃ¡ vacÃ­o.</p>
        </div>

        <div class="flex justify-between font-bold text-xl text-gray-700">
          <span>Total:</span>
          <span id="total" class="text-orange-600">$0.00</span>
        </div>

        <button
          id="checkout-btn"
          class="w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white py-3 rounded-xl font-semibold text-lg shadow-md hover:shadow-lg hover:scale-[1.02] transition-all">
          ðŸ§¾ Realizar Pedido
        </button>
      </aside>

    </div>
  </div>

  <!-- SCRIPT FINAL - SIN ERRORES 404 -->
  <script is:inline type="module">
    const cartList = document.getElementById('cart-list');
    const totalSpan = document.getElementById('total');
    const emptyMsg = document.getElementById('empty-msg');
    const checkoutBtn = document.getElementById('checkout-btn');
    const productsContainer = document.getElementById('products-container');

    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

    function showToast(message, color = 'green') {
      const toast = document.createElement("div");
      toast.className = `toast fixed bottom-6 right-6 px-5 py-3 rounded-lg text-white font-semibold shadow-lg bg-${color}-500`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    function renderCart() {
      cartList.innerHTML = '';

      if (cart.length === 0) {
        emptyMsg.classList.remove("hidden");
        totalSpan.textContent = "$0.00";
        checkoutBtn.disabled = true;
        checkoutBtn.classList.add("opacity-50", "cursor-not-allowed");
        return;
      } else {
        emptyMsg.classList.add("hidden");
        checkoutBtn.disabled = false;
        checkoutBtn.classList.remove("opacity-50", "cursor-not-allowed");
      }

      let total = 0;

      cart.forEach((item, index) => {
        const li = document.createElement('li');
        li.className =
          "flex items-center justify-between bg-white p-4 rounded-2xl shadow-md hover:shadow-lg transition-all border border-orange-200 animate-fade-in";

        // IMAGEN SEGURA - SIN /assets/placeholder.png
        const itemImg = item.img || `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="%23fef3c7" stroke="%23f97316" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><text x="12" y="16" font-family="Arial" font-size="10" text-anchor="middle" fill="%23f97316">${item.name.charAt(0)}</text></svg>`;
        
        li.innerHTML = `
          <div class="flex items-center gap-4">
            <img 
              src="${itemImg}"
              alt="${item.name}"
              class="w-16 h-16 rounded-xl object-cover border border-orange-200 shadow-sm bg-white"
            />
            <div class="leading-tight">
              <p class="font-bold text-gray-800 text-lg">${item.name}</p>
              <p class="text-sm text-gray-500">$${item.price} x ${item.qty}</p>
              <div class="flex items-center gap-2 mt-1">
                <button data-index="${index}" data-action="decrease" 
                  class="w-6 h-6 flex items-center justify-center bg-gray-200 rounded-full text-sm hover:bg-gray-300">
                  -
                </button>
                <span class="text-gray-700">${item.qty}</span>
                <button data-index="${index}" data-action="increase"
                  class="w-6 h-6 flex items-center justify-center bg-gray-200 rounded-full text-sm hover:bg-gray-300">
                  +
                </button>
              </div>
            </div>
          </div>

          <div class="flex flex-col items-end gap-2">
            <span class="font-bold text-gray-700">$${(item.price * item.qty).toFixed(2)}</span>
            <button data-index="${index}" data-action="remove"
              class="text-red-500 hover:text-red-700 text-lg font-bold px-2 transition">
              âœ• Eliminar
            </button>
          </div>
        `;

        cartList.appendChild(li);

        // Botones para modificar cantidad
        li.querySelectorAll('button[data-action]').forEach(btn => {
          btn.onclick = (e) => {
            const i = Number(e.target.dataset.index);
            const action = e.target.dataset.action;
            
            if (action === 'remove') {
              const removed = cart.splice(i, 1)[0];
              showToast(`${removed.name} eliminado`, "red");
            } else if (action === 'increase') {
              cart[i].qty++;
            } else if (action === 'decrease') {
              if (cart[i].qty > 1) {
                cart[i].qty--;
              } else {
                const removed = cart.splice(i, 1)[0];
                showToast(`${removed.name} eliminado`, "red");
              }
            }
            
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
          };
        });

        total += item.price * item.qty;
      });

      totalSpan.textContent = `$${total.toFixed(2)}`;
    }

    // --- TRAER PRODUCTOS DE SUPABASE ---
    async function fetchProducts() {
      try {
        const { data: productos, error } = await supabase
          .from('productos')
          .select('*')
          .order('nombre');

        if (error) throw error;

        productsContainer.innerHTML = '';

        productos.forEach(product => {
          // IMAGEN SEGURA para productos
          const productImg = product.imagen || `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24" fill="%23fef3c7" stroke="%23f97316" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><text x="12" y="14" font-family="Arial" font-size="8" text-anchor="middle" fill="%23f97316">${product.nombre.substring(0, 10)}</text></svg>`;
          
          const div = document.createElement('div');
          div.className = 'bg-white p-4 rounded-2xl shadow-md flex flex-col items-center gap-3 hover:shadow-lg transition-all';
          div.innerHTML = `
            <img src="${productImg}" 
                 alt="${product.nombre}" 
                 class="w-32 h-32 rounded-lg object-cover border border-orange-200"/>
            <p class="font-bold text-center text-gray-800">${product.nombre}</p>
            <p class="text-orange-600 font-semibold text-lg">$${product.precio}</p>
            <button data-id="${product.id}" 
                    class="bg-gradient-to-r from-orange-500 to-orange-600 text-white py-2 px-4 rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all font-medium">
              âž• Agregar al carrito
            </button>
          `;

          productsContainer.appendChild(div);

          div.querySelector('button').onclick = () => {
            const existing = cart.find(p => p.id === product.id);
            if (existing) {
              existing.qty++;
            } else {
              cart.push({ 
                id: product.id, 
                name: product.nombre, 
                price: product.precio, 
                img: product.imagen, 
                qty: 1 
              });
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
            showToast(`âœ“ ${product.nombre} agregado`, 'green');
          };
        });
      } catch (error) {
        console.error('Error al cargar productos:', error);
        showToast('Error al cargar productos', 'red');
      }
    }

    // --- FUNCIÃ“N DE CHECKOUT SIMPLIFICADA ---
    checkoutBtn.onclick = async () => {
      try {
        // 1. Validar carrito
        if (cart.length === 0) {
          showToast("Tu carrito estÃ¡ vacÃ­o", "red");
          return;
        }

        const total = cart.reduce((sum, p) => sum + p.price * p.qty, 0);
        
        // Formatear cart para enviar
        const cartData = cart.map(item => ({
          id: item.id,
          name: item.name,
          price: item.price,
          qty: item.qty,
          img: item.img
        }));

        // 2. Estado de carga
        const originalText = checkoutBtn.innerHTML;
        checkoutBtn.disabled = true;
        checkoutBtn.innerHTML = 'âŒ› Procesando...';

        console.log('ðŸ”„ Enviando pedido al servidor...');

        // 3. Llamar al endpoint de checkout (CON CREDENTIALS)
        const response = await fetch('/api/checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include', // â† AGREGAR ESTA LÃNEA
          body: JSON.stringify({
            cart: cartData,
            total: total
            // â† QUITAR user_id: user_id
          })
        });

        const result = await response.json();
        console.log('ðŸ“¥ Respuesta del servidor:', result);

        if (!response.ok) {
          // Si hay error 401 (no autenticado)
          if (response.status === 401) {
            showToast("Por favor, inicia sesiÃ³n primero", "yellow");
            setTimeout(() => {
              window.location.href = `/login?redirect=${encodeURIComponent(window.location.pathname)}`;
            }, 1500);
            return;
          }
          throw new Error(result.error || 'Error al procesar el pedido');
        }

        console.log('âœ… Pedido creado con ID:', result.pedido_id);

        // 4. Opcional: Enviar WhatsApp
        try {
          let mensaje = `ðŸŽ‚ *NUEVO PEDIDO* ðŸŽ‚\n\n`;
          mensaje += `*ID:* ${result.pedido_id?.slice(0, 8) || 'N/A'}\n`;
          mensaje += `*Total:* $${total.toFixed(2)}\n\n`;
          mensaje += `*Productos:*\n`;
          cart.forEach((item, i) => {
            mensaje += `${i + 1}. ${item.name} - ${item.qty} x $${item.price}\n`;
          });
          mensaje += `\n---\nðŸ“± Pedido web`;

          if (telefonoDuenha) {
            window.open(`https://wa.me/${telefonoDuenha}?text=${encodeURIComponent(mensaje)}`, '_blank');
          }
        } catch (error) {
          console.warn('âš ï¸ Error WhatsApp:', error);
        }

        // 5. Mostrar confirmaciÃ³n
        showToast(`âœ… Pedido #${result.pedido_id?.slice(0, 8) || ''} registrado!`, "green");

        // 6. Limpiar carrito
        setTimeout(() => {
          cart = [];
          localStorage.removeItem('cart');
          renderCart();
          
          checkoutBtn.disabled = false;
          checkoutBtn.innerHTML = originalText;
          
          alert(`ðŸŽ‰ Â¡PEDIDO REGISTRADO!\n\nID: ${result.pedido_id?.slice(0, 8) || 'N/A'}\nTotal: $${total.toFixed(2)}\n\nRevisa "Mis Pedidos" para ver el estado.`);
          
        }, 1000);

      } catch (error) {
        console.error('âŒ Error en checkout:', error);
        showToast(`âŒ Error: ${error.message}`, "red");
        
        checkoutBtn.disabled = false;
        checkoutBtn.innerHTML = 'ðŸ§¾ Realizar Pedido';
      }
    };

    // --- INICIALIZAR ---
    document.addEventListener('DOMContentLoaded', () => {
      fetchProducts();
      renderCart();
    });

  </script>

  <!-- ESTILOS -->
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fade-in {
      animation: fadeIn 0.35s ease-out forwards;
    }

    #cart-list {
      max-height: 500px;
      overflow-y: auto;
      padding-right: 10px;
    }

    #cart-list::-webkit-scrollbar {
      width: 6px;
    }

    #cart-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    #cart-list::-webkit-scrollbar-thumb {
      background: #f97316;
      border-radius: 10px;
    }

    #cart-list::-webkit-scrollbar-thumb:hover {
      background: #ea580c;
    }
  </style>
</BaseLayout>
